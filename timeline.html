<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            text-align: center;
            background-color: #f9f9f9;
        }
        nav {
            background-color: #333;
            padding: 10px 0;
            display: flex;
            justify-content: center;
            width: 100%;
        }
        nav a {
            color: #fff;
            padding: 10px 20px;
            text-decoration: none;
            font-weight: bold;
        }
        nav a.active {
            background-color: #555;
            border-radius: 5px;
        }
        .content {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            padding: 40px 20px;
            border-radius: 10px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }
        #inputBox {
            width: 100%;
            height: 150px;
            resize: none;
        }
        #timeline {
            margin-top: 30px;
            width: 100%;
            position: relative;
            height: 60px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .segment {
            position: absolute;
            top: 0;
            height: 100%;
        }
        .free { background-color: #7ed957; }
        .busy { background-color: #ff5757; }
        .override { background-color: yellow !important; }
            .hour-marker {
            position: absolute;
            top: 0;
            width: 1px;
            height: 100%;
            background: #0003;
        }
        .hour-label {
            position: absolute;
            top: -20px;
            font-size: 12px;
            transform: translateX(-50%);
        }
</style>
</head>
<body>

<nav>
        <a href="numbers.html">Numbers Index</a>
        <a href="timeline.html" class="active">Timeline visualiser for CRM+</a>
</nav>

<div class="content">
    <h2>Call Timeline Visualizer</h2>
    <p>Paste your raw time list below:</p>
    <textarea id="inputBox"></textarea>
    <br><br>
    <button onclick="drawTimeline()">Parse & Draw</button>

    <div id="timeline"></div>
</div>


<script>
let yellow = null;
let drag = null;
let startX = 0;

// Parse "8:18 AM" -> minutes since midnight
function parseTime(t) {
    if (!t) return NaN;
    t = t.trim();
    // Split by whitespace: "8:18 AM" => ["8:18", "AM"]
    const parts = t.split(/\s+/);
    if (parts.length < 2) return NaN;
    const timePart = parts[0];
    const ampm = parts[1].toUpperCase();

    const hm = timePart.split(':');
    if (hm.length !== 2) return NaN;
    let h = parseInt(hm[0], 10);
    let m = parseInt(hm[1], 10);
    if (Number.isNaN(h) || Number.isNaN(m)) return NaN;

    if (ampm === 'PM' && h !== 12) h += 12;
    if (ampm === 'AM' && h === 12) h = 0;
    return h * 60 + m;
}

// Merge overlapping/adjacent intervals
function mergeIntervals(intervals) {
    if (!intervals.length) return [];
    intervals.sort((a, b) => a.from - b.from);
    const merged = [];
    let cur = { ...intervals[0] };
    for (let i = 1; i < intervals.length; i++) {
        const x = intervals[i];
        if (x.from <= cur.to) {
            // overlap or touch; extend
            cur.to = Math.max(cur.to, x.to);
        } else {
            merged.push(cur);
            cur = { ...x };
        }
    }
    merged.push(cur);
    return merged;
}

function drawTimeline() {
    yellow = null; // reset override
    const rawText = document.getElementById('inputBox').value;
    const timeline = document.getElementById('timeline');
    timeline.innerHTML = '';

    // Business hours
    const start = 8 * 60;         // 8:00 AM
    const end = 17 * 60 + 30;     // 5:30 PM
    const total = end - start;

    // Hour markers and labels
    for (let h = 8; h <= 17; h++) {
        const pos = ((h * 60 - start) / total) * 100;
        const m = document.createElement('div');
        m.className = 'hour-marker';
        m.style.left = pos + '%';
        timeline.appendChild(m);

        const label = document.createElement('div');
        label.className = 'hour-label';
        label.style.left = pos + '%';
        label.textContent = `${(h % 12) === 0 ? 12 : (h % 12)}:00 ${h < 12 ? 'AM' : 'PM'}`;
        timeline.appendChild(label);
    }

    // Parse lines robustly
    const lines = rawText
        .trim()
        .split(/\r?\n/)        // handle \n and \r\n
        .filter(line => line.trim().length > 0);

    let calls = [];
    for (const line of lines) {
        const parts = line.split(/\t+/); // one or more tabs
        if (parts.length < 2) continue;
        const fromMin = parseTime(parts[0]);
        const toMin = parseTime(parts[1]);

        if (Number.isNaN(fromMin) || Number.isNaN(toMin)) continue;
        // Skip invalid or zero-length (optional; keep zero-length if you want to see pips)
        if (toMin < fromMin) continue;

        // Clamp to business hours (optional)
        const clampedFrom = Math.max(fromMin, start);
        const clampedTo = Math.min(toMin, end);
        if (clampedTo <= clampedFrom) continue;

        calls.push({ from: clampedFrom, to: clampedTo });
    }

    // Merge overlaps/adjacent
    calls = mergeIntervals(calls);

    // Draw busy segments
    for (const c of calls) {
        const leftPct = ((c.from - start) / total) * 100;
        const widthPct = ((c.to - c.from) / total) * 100;
        const div = document.createElement('div');
        div.className = 'segment busy';
        div.style.left = leftPct + '%';
        div.style.width = widthPct + '%';
        timeline.appendChild(div);
    }

    // Compute and draw free segments
    const free = [];
    let cursor = start;
    for (const c of calls) {
        if (c.from > cursor) free.push({ from: cursor, to: c.from });
        cursor = Math.max(cursor, c.to);
    }
    if (cursor < end) free.push({ from: cursor, to: end });

    for (const f of free) {
        const leftPct = ((f.from - start) / total) * 100;
        const widthPct = ((f.to - f.from) / total) * 100;
        const div = document.createElement('div');
        div.className = 'segment free';
        div.style.left = leftPct + '%';
        div.style.width = widthPct + '%';
        timeline.appendChild(div);
    }

    // Click to create yellow override block
    timeline.onclick = e => {
        if (yellow) return; // only one override
        const box = timeline.getBoundingClientRect();
        const clickPct = ((e.clientX - box.left) / box.width) * 100;

        yellow = document.createElement('div');
        yellow.className = 'segment override';
        yellow.style.position = 'absolute';
        yellow.style.left = Math.max(0, Math.min(clickPct, 95)) + '%';
        yellow.style.width = '5%';

        // Right handle
        const rightH = document.createElement('div');
        rightH.style.position = 'absolute';
        rightH.style.top = '0';
        rightH.style.right = '0';
        rightH.style.width = '6px';
        rightH.style.height = '100%';
        rightH.style.cursor = 'ew-resize';
        rightH.style.background = '#0003';
        yellow.appendChild(rightH);

        yellow.onmousedown = e2 => {
            if (e2.target === rightH) drag = 'resize-right';
            else drag = 'move';
            startX = e2.clientX;
            e2.preventDefault();
        };

        timeline.appendChild(yellow);
    };

    document.onmouseup = () => { drag = null; };
    document.onmousemove = e => {
        if (!drag || !yellow) return;
        const dx = e.clientX - startX;
        startX = e.clientX;

        const box = timeline.getBoundingClientRect();
        const ybox = yellow.getBoundingClientRect();

        let leftPct = (ybox.left - box.left) / box.width * 100;
        let widthPct = ybox.width / box.width * 100;

        if (drag === 'move') {
            leftPct += dx / box.width * 100;
            leftPct = Math.max(0, Math.min(leftPct, 100 - widthPct));
        }
        if (drag === 'resize-right') {
            widthPct += dx / box.width * 100;
            if (leftPct + widthPct > 100) widthPct = 100 - leftPct;
            if (widthPct < 1) widthPct = 1;
        }

        yellow.style.left = leftPct + '%';
        yellow.style.width = widthPct + '%';
    };
}
</script>


</body>
</html>
